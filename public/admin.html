<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Admin - Performance Data Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
</head>
<body>
    <div class="container-fluid">
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
            <div class="container-fluid">
                <a class="navbar-brand" href="#">Portfolio Admin</a>
                <div class="navbar-nav ms-auto d-flex align-items-center">
                    <a class="nav-link" href="transactions.html">
                        <i class="fas fa-exchange-alt me-1"></i>Transactions
                    </a>
                    <li class="nav-item d-flex align-items-center ms-3">
                        <label class="theme-switcher" id="theme-toggle" title="Toggle Dark/Light Theme">
                            <input type="checkbox">
                            <span class="theme-slider">
                                <i class="fas fa-sun theme-icon sun"></i>
                                <i class="fas fa-moon theme-icon moon"></i>
                            </span>
                        </label>
                    </li>
                    <a class="nav-link ms-3" href="/">Back to App</a>
                </div>
            </div>
        </nav>

        <div class="container mt-4">
            <h1 class="mb-4">Performance Data Management</h1>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5>Generate Performance Data</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="portfolioSelect" class="form-label">Portfolio</label>
                                <select class="form-select" id="portfolioSelect">
                                    <option value="">All Portfolios</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="daysInput" class="form-label">Number of Days</label>
                                <input type="number" class="form-control" id="daysInput" value="30" min="1" max="365">
                            </div>
                            <button class="btn btn-primary" onclick="generateData()">Generate Data</button>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5>Current Data Status</h5>
                        </div>
                        <div class="card-body">
                            <div id="dataStatus">Loading...</div>
                            <button class="btn btn-secondary btn-sm mt-2" onclick="checkStatus()">Refresh Status</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5>Action Log</h5>
                        </div>
                        <div class="card-body">
                            <div id="actionLog" style="height: 200px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 4px;">
                                <p class="text-muted">No actions yet...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/theme.js"></script>
    <script src="js/api.js"></script>
    <script>
        let portfolios = [];

        async function loadPortfolios() {
            try {
                const response = await api.getPortfolios();
                if (response.success) {
                    portfolios = response.data;
                    const select = document.getElementById('portfolioSelect');
                    select.innerHTML = '<option value="">All Portfolios</option>';
                    portfolios.forEach(portfolio => {
                        select.innerHTML += `<option value="${portfolio.id}">${portfolio.name}</option>`;
                    });
                }
            } catch (error) {
                logAction('Error loading portfolios: ' + error.message, 'error');
            }
        }

        async function checkStatus() {
            try {
                const response = await fetch('/api/admin/performance-status');
                const result = await response.json();
                
                if (result.success) {
                    const statusDiv = document.getElementById('dataStatus');
                    statusDiv.innerHTML = result.data.map(item => 
                        `<div class="mb-2">
                            <strong>${item.name}</strong><br>
                            <small>Records: ${item.records} | Range: ${item.earliest || 'None'} to ${item.latest || 'None'}</small>
                        </div>`
                    ).join('');
                } else {
                    logAction('Error checking status: ' + result.message, 'error');
                }
            } catch (error) {
                logAction('Error checking status: ' + error.message, 'error');
            }
        }

        async function generateData() {
            const portfolioId = document.getElementById('portfolioSelect').value;
            const days = document.getElementById('daysInput').value;
            
            try {
                logAction(`Generating ${days} days of data for ${portfolioId ? 'portfolio ' + portfolioId : 'all portfolios'}...`, 'info');
                
                const response = await fetch('/api/admin/generate-performance', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        portfolioId: portfolioId || null,
                        days: parseInt(days)
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    logAction('Performance data generated successfully!', 'success');
                    checkStatus(); // Refresh status
                } else {
                    logAction('Error generating data: ' + result.message, 'error');
                }
            } catch (error) {
                logAction('Error generating data: ' + error.message, 'error');
            }
        }

        function logAction(message, type = 'info') {
            const logDiv = document.getElementById('actionLog');
            const timestamp = new Date().toLocaleTimeString();
            const colorClass = type === 'error' ? 'text-danger' : type === 'success' ? 'text-success' : 'text-info';
            
            logDiv.innerHTML += `<div class="${colorClass}"><small>${timestamp}</small> ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadPortfolios();
            checkStatus();
        });
    </script>
</body>
</html>
